@extends('layouts.app')

@section('content')
    <div class="page-header">
        <div class="row">
            <div class="col">
                <h3 class="page-title">Pengajuan Pembelian</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ route('home') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ route('ajukan.index') }}">Pengajuan Pembelian</a></li>
                    <li class="breadcrumb-item active">Tambah Pengajuan Pembelian</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <form action="{{ route('ajukan.store') }}" method="POST">
                @csrf
                <div class="card mb-4">
                    <div class="card-header bg-dark">
                        <h4 class="card-title mb-0">Formulir Pengajuan Pembelian</h4>
                        <p class="card-text mb-0">
                            Silakan isi data pengajuan pembelian di bawah ini.
                        </p>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="tanggal" class="form-label"><strong>Tanggal</strong></label>
                                <input type="date" name="Tanggal" id="tanggal"
                                    class="form-control @error('Tanggal') is-invalid @enderror"
                                    value="{{ old('Tanggal', date('Y-m-d')) }}" min="{{ date('Y-m-d') }}"
                                    placeholder="Pilih tanggal">
                                @error('Tanggal')
                                    <div class="text-danger mt-1">{{ $message }}</div>
                                @enderror
                                <input type="hidden" name="IdPermintaan" value="{{ $permintaan->id }}">
                            </div>
                            <div class="col-md-4">
                                <label for="jenis" class="form-label"><strong>Jenis</strong></label>
                                <select name="Jenis" id="jenis"
                                    class="form-select @error('Jenis') is-invalid @enderror">
                                    <option value="">Pilih Jenis Pengajuan</option>
                                    <option value="Medis" {{ old('Jenis') == 'Medis' ? 'selected' : '' }}>Medis</option>
                                    <option value="Umum" {{ old('Jenis') == 'Umum' ? 'selected' : '' }}>Umum</option>
                                </select>
                                @error('Jenis')
                                    <div class="text-danger mt-1">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="perkiraan_utilisasi" class="form-label"><strong>Perkiraan Utilitasi
                                        Bulanan</strong></label>
                                <input type="text" name="PerkiraanUtilitasiBulanan" id="perkiraan_utilisasi"
                                    class="form-control @error('PerkiraanUtilitasiBulanan') is-invalid @enderror"
                                    value="{{ old('PerkiraanUtilitasiBulanan') }}"
                                    placeholder="Contoh: 200 jam/bulan, 30 unit/bulan, dll">
                                <small class="text-danger">Ketik "-" jika barang jasa / umum</small>
                                @error('PerkiraanUtilitasiBulanan')
                                    <div class="text-danger mt-1">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-4">
                                <label for="perkiraan_bep" class="form-label"><strong>Perkiraan BEP Pada
                                        Tahun</strong></label>
                                <input type="text" name="PerkiraanBepPadaTahun" id="perkiraan_bep"
                                    class="form-control @error('PerkiraanBepPadaTahun') is-invalid @enderror"
                                    value="{{ old('PerkiraanBepPadaTahun') }}" placeholder="Masukkan tahun perkiraan BEP">
                                <small class="text-danger">Ketik "-" jika barang jasa / umum</small>
                                @error('PerkiraanBepPadaTahun')
                                    <div class="text-danger mt-1">{{ $message }}</div>
                                @enderror
                            </div>
                            <div class="col-md-2">
                                <label for="rkap" class="form-label">
                                    <strong>RAB Project / RKAP</strong>
                                </label>
                                <input type="text" name="Rkap" id="rkap"
                                    class="form-control @error('Rkap') is-invalid @enderror" value="{{ old('Rkap') }}"
                                    placeholder="Masukkan RKAP">
                                <small class="text-danger">Ketik "-" jika barang medis</small>
                                @error('Rkap')
                                    <div class="text-danger mt-1">{{ $message }}</div>
                                @enderror

                            </div>
                            <div class="col-md-2">
                                <label for="nominal_rkap" class="form-label"><strong>Nominal RKAP</strong></label>
                                <input type="number" name="NominalRkap" id="nominal_rkap"
                                    class="form-control @error('NominalRkap') is-invalid @enderror"
                                    value="{{ old('NominalRkap') }}" placeholder="Contoh: 1000000">
                                @error('NominalRkap')
                                    <div class="text-danger mt-1">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-xxl-12 col-xl-12">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            Perbandingan Vendor
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <ul class="nav nav-tabs tab-style-1 d-sm-flex d-block" role="tablist">
                                            @for ($vn = 1; $vn <= 3; $vn++)
                                                <li class="nav-item">
                                                    <a class="nav-link {{ $vn == 1 ? 'active' : '' }}" data-bs-toggle="tab"
                                                        data-bs-target="#vendor_tab_{{ $vn }}"
                                                        href="#vendor_tab_{{ $vn }}">
                                                        Vendor {{ $vn }}
                                                    </a>
                                                </li>
                                            @endfor
                                        </ul>
                                        <div class="tab-content">
                                            @for ($vn = 1; $vn <= 3; $vn++)
                                                <div class="tab-pane{{ $vn == 1 ? ' active' : '' }}"
                                                    id="vendor_tab_{{ $vn }}" role="tabpanel">
                                                    <div class="row mb-3">
                                                        <div class="col-xl-6">
                                                            <div class="card">
                                                                <div class="row g-0">
                                                                    <div class="col-md-8">
                                                                        <div class="card-header">
                                                                            <div class="card-title">
                                                                                <label
                                                                                    for="vendor_select_{{ $vn }}"
                                                                                    class="form-label mb-0"><strong>Pilih
                                                                                        Vendor</strong></label>
                                                                                <select
                                                                                    class="form-control select2 main-vendor-select"
                                                                                    id="vendor_select_{{ $vn }}"
                                                                                    name="vendor_select_{{ $vn }}"
                                                                                    style="width:100%;"
                                                                                    data-placeholder="Pilih Vendor"
                                                                                    onchange="updateVendorInfoAndLock({{ $vn }})">
                                                                                    <option value="">-- Pilih Vendor
                                                                                        --</option>
                                                                                    @foreach ($vendor as $v)
                                                                                        <option
                                                                                            value="{{ $v->id }}"
                                                                                            data-namapic="{{ $v->NamaPic ?? '' }}"
                                                                                            data-nohppic="{{ $v->NoHpPic ?? '' }}">
                                                                                            {{ $v->Nama }}
                                                                                        </option>
                                                                                    @endforeach
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="card-body">
                                                                            <div id="vendor_info_{{ $vn }}">
                                                                                <h6 class="card-title fw-semibold mb-2">
                                                                                    Informasi Vendor Berdasarkan Pilihan
                                                                                </h6>
                                                                                <table class="table table-bordered mb-0">
                                                                                    <tr>
                                                                                        <th>Nama PIC</th>
                                                                                        <td><span
                                                                                                class="vendor_namapic">-</span>
                                                                                        </td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <th>No HP PIC</th>
                                                                                        <td><span
                                                                                                class="vendor_nohppic">-</span>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="col-md-4">
                                                                        <img src="{{ asset('assets/img/ccp/vendor.png') }}"
                                                                            class="img-fluid rounded-end object-fit-cover h-100 w-100"
                                                                            alt="...">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-xl-6">

                                                            <div class="col-md-12">
                                                                <label for="penawaran_vendor_{{ $vn }}"
                                                                    class="form-label"><strong>Upload Surat Penawaran
                                                                        Vendor
                                                                        {{ $vn }}</strong></label>
                                                                <input class="form-control" type="file"
                                                                    id="penawaran_vendor_{{ $vn }}"
                                                                    name="penawaran_vendor_{{ $vn }}"
                                                                    accept=".pdf,.jpg,.jpeg,.png" multiple
                                                                    style="border: 2px dashed #ced4da; padding: 20px;"
                                                                    ondragover="this.classList.add('dragover')"
                                                                    ondragleave="this.classList.remove('dragover')"
                                                                    onchange="this.classList.remove('dragover')">
                                                                <small class="form-text text-muted">Anda bisa drag and drop
                                                                    file
                                                                    di area ini atau klik untuk memilih file.</small>
                                                                @error('penawaran_vendor_{{ $vn }}')
                                                                    <div class="text-danger mt-1">
                                                                        {{ $message }}
                                                                    </div>
                                                                @enderror
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="table-responsive">

                                                        <table class="table align-middle"
                                                            id="table-detail-pembelian-{{ $vn }}">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Barang</th>
                                                                    <th>Nama Vendor</th>
                                                                    <th>Jumlah</th>
                                                                    <th>Harga Satuan</th>
                                                                    <th>Diskon</th>
                                                                    <th>Jenis Diskon</th>
                                                                    <th>Total Diskon</th>
                                                                    <th>Total Harga</th>

                                                                </tr>
                                                            </thead>
                                                            <tbody id="table-detail-body-{{ $vn }}">
                                                                @forelse ($permintaan->getDetail as $key => $barang)
                                                                    <tr>
                                                                        <td width="15%">
                                                                            <select
                                                                                name="vendors[{{ $vn }}][{{ $key }}][NamaBarang]"
                                                                                class="form-control select2 barang-name-in-table"
                                                                                data-placeholder="Pilih Barang"
                                                                                style="width: 100%;">
                                                                                <option value="">Pilih Barang
                                                                                </option>
                                                                                @foreach ($masterbarang as $b)
                                                                                    <option value="{{ $b->id }}"
                                                                                        @if ($barang->NamaBarang == $b->id) selected @endif>
                                                                                        {{ $b->Nama }}
                                                                                    </option>
                                                                                @endforeach
                                                                            </select>
                                                                        </td>
                                                                        <td width="15%">
                                                                            <select
                                                                                name="vendors[{{ $vn }}][{{ $key }}][NamaVendor]"
                                                                                class="form-control select2 vendor-name-in-table"
                                                                                data-placeholder="Pilih Vendor"
                                                                                style="width: 100%;">
                                                                                <option value="">Pilih Vendor
                                                                                </option>
                                                                                @foreach ($vendor as $v)
                                                                                    <option value="{{ $v->id }}">
                                                                                        {{ $v->Nama }}</option>
                                                                                @endforeach
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <input type="number"
                                                                                name="vendors[{{ $vn }}][{{ $key }}][Jumlah]"
                                                                                class="form-control jumlah-vendor-input-{{ $vn }}"
                                                                                placeholder="Jumlah"
                                                                                oninput="hitungOtomatis{{ $vn }}(this)"
                                                                                value="{{ $barang->Jumlah }}" readonly>
                                                                        </td>
                                                                        <td>
                                                                            <input type="text"
                                                                                name="vendors[{{ $vn }}][{{ $key }}][HargaSatuan]"
                                                                                class="form-control harga-satuan-input-{{ $vn }} currency-input-{{ $vn }}"
                                                                                placeholder="Harga Satuan"
                                                                                oninput="hitungOtomatis{{ $vn }}(this); formatRupiahInput{{ $vn }}(this);"
                                                                                onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                        </td>
                                                                        <td>
                                                                            <input type="text"
                                                                                name="vendors[{{ $vn }}][{{ $key }}][DiskonItem]"
                                                                                class="form-control diskon-item-input-{{ $vn }} currency-input-{{ $vn }}"
                                                                                placeholder="Diskon"
                                                                                oninput="hitungOtomatis{{ $vn }}(this);"
                                                                                onkeyup="">
                                                                        </td>
                                                                        <td>
                                                                            <select
                                                                                name="vendors[{{ $vn }}][{{ $key }}][JenisDiskonItem]"
                                                                                class="form-control jenis-diskon-item-select-{{ $vn }}"
                                                                                onchange="hitungOtomatis{{ $vn }}(this)">
                                                                                <option value="Rp">Rp</option>
                                                                                <option value="Persen">Persen</option>
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <input type="text"
                                                                                name="vendors[{{ $vn }}][{{ $key }}][TotalDiskon]"
                                                                                class="form-control total-diskon-input-{{ $vn }} currency-input-{{ $vn }}"
                                                                                placeholder="Total Diskon" readonly
                                                                                onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                        </td>
                                                                        <td>
                                                                            <input type="text"
                                                                                name="vendors[{{ $vn }}][{{ $key }}][TotalHarga]"
                                                                                class="form-control total-harga-input-{{ $vn }} currency-input-{{ $vn }}"
                                                                                placeholder="Total Harga" readonly
                                                                                onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                        </td>
                                                                        {{-- <td class="text-center">
                                                                            {!! $jenisButton !!}
                                                                        </td> --}}
                                                                    </tr>
                                                                @empty
                                                                    <tr>
                                                                        <td colspan="8" class="text-center">Tidak ada
                                                                            barang pada
                                                                            permintaan ini.</td>
                                                                    </tr>
                                                                @endforelse
                                                            </tbody>
                                                            <tfoot>
                                                                <tr>
                                                                    <td colspan="6" class="text-end"><strong>Total
                                                                            Harga Sebelum
                                                                            Diskon</strong></td>
                                                                    <td colspan="2">
                                                                        <input type="text"
                                                                            name="vendors[{{ $vn }}][total_harga_sebelum_diskon_all]"
                                                                            id="total-harga-sebelum-diskon-all-{{ $vn }}"
                                                                            class="form-control currency-input-{{ $vn }}"
                                                                            placeholder="Total Harga Sebelum Diskon"
                                                                            readonly
                                                                            onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="6" class="text-end"><strong>Harga
                                                                            Setelah
                                                                            Diskon</strong></td>
                                                                    <td colspan="2">
                                                                        <input type="text"
                                                                            name="vendors[{{ $vn }}][total_harga_setelah_diskon_all]"
                                                                            id="total-harga-setelah-diskon-all-{{ $vn }}"
                                                                            class="form-control currency-input-{{ $vn }}"
                                                                            placeholder="Total Harga Setelah Diskon"
                                                                            readonly
                                                                            onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="6" class="text-end"><strong>Total
                                                                            Diskon</strong></td>
                                                                    <td colspan="2">
                                                                        <input type="text"
                                                                            name="vendors[{{ $vn }}][total_diskon_all]"
                                                                            id="total-diskon-all-{{ $vn }}"
                                                                            class="form-control currency-input-{{ $vn }}"
                                                                            placeholder="Total Semua Diskon" readonly
                                                                            onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="6" class="text-end">
                                                                        <strong>PPN (%)</strong>
                                                                    </td>
                                                                    <td colspan="1">
                                                                        <input type="number"
                                                                            name="vendors[{{ $vn }}][ppn_persen]"
                                                                            id="ppn-persen-{{ $vn }}"
                                                                            class="form-control" placeholder="PPN (%)"
                                                                            oninput="hitungOtomatisGlobal{{ $vn }}()">
                                                                    </td>
                                                                    <td></td>
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="6" class="text-end"><strong>Total PPN
                                                                            (All)</strong></td>
                                                                    <td colspan="2">
                                                                        <input type="text"
                                                                            name="vendors[{{ $vn }}][total_ppn_all]"
                                                                            id="total-ppn-all-{{ $vn }}"
                                                                            class="form-control currency-input-{{ $vn }}"
                                                                            placeholder="Total Semua PPN" readonly
                                                                            onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="6" class="text-end"><strong>Grand
                                                                            Total</strong></td>
                                                                    <td colspan="2">
                                                                        <input type="text"
                                                                            name="vendors[{{ $vn }}][grand_total]"
                                                                            id="grand-total-{{ $vn }}"
                                                                            class="form-control currency-input-{{ $vn }}"
                                                                            placeholder="Grand Total" readonly
                                                                            onkeyup="formatRupiahInput{{ $vn }}(this);">
                                                                    </td>
                                                                </tr>
                                                            </tfoot>
                                                        </table>
                                                        <script>
                                                            // Fungsi untuk formatting angka ke Rupiah (khusus vendor tab {{ $vn }})
                                                            function formatRupiah{{ $vn }}(angka, prefix = "Rp ") {
                                                                if (angka === null || angka === undefined) return '';
                                                                let number_string = angka.toString().replace(/[^,\d]/g, ''),
                                                                    split = number_string.split(','),
                                                                    sisa = split[0].length % 3,
                                                                    rupiah = split[0].substr(0, sisa),
                                                                    ribuan = split[0].substr(sisa).match(/\d{3}/gi);

                                                                if (ribuan) {
                                                                    let separator = sisa ? '.' : '';
                                                                    rupiah += separator + ribuan.join('.');
                                                                }

                                                                rupiah = split[1] !== undefined ? rupiah + ',' + split[1] : rupiah;
                                                                return prefix + rupiah;
                                                            }

                                                            // Format input otomatis (khusus tab {{ $vn }})
                                                            function formatRupiahInput{{ $vn }}(input) {
                                                                if (input.hasAttribute('readonly')) return;
                                                                let nilai = input.value.replace(/[^,\d]/g, '');
                                                                if (!nilai) {
                                                                    input.value = '';
                                                                    return;
                                                                }
                                                                let formatted = formatRupiah{{ $vn }}(nilai, "Rp ");
                                                                input.value = formatted;
                                                            }

                                                            function parseNum{{ $vn }}(val) {
                                                                if (typeof val === 'string') {
                                                                    val = val.replace(/[^0-9\,\-]/g, "");
                                                                    val = val.replace(/\./g, "");
                                                                    val = val.replace(',', '.');
                                                                }
                                                                let x = parseFloat(val);
                                                                return isNaN(x) ? 0 : x;
                                                            }

                                                            // Helper: trigger perhitungan global per tab
                                                            function hitungOtomatisGlobal{{ $vn }}() {
                                                                let $first = $(
                                                                        "#table-detail-body-{{ $vn }} input, #table-detail-body-{{ $vn }} select")
                                                                    .first();
                                                                if ($first.length) hitungOtomatis{{ $vn }}($first[0]);
                                                            }

                                                            // Logic perhitungan tab {{ $vn }}
                                                            function hitungOtomatis{{ $vn }}(elem) {
                                                                let $row = $(elem).closest('tr');
                                                                let jumlah = parseNum{{ $vn }}($row.find('.jumlah-vendor-input-{{ $vn }}').val());
                                                                let hargaSatuan = parseNum{{ $vn }}($row.find('.harga-satuan-input-{{ $vn }}').val());

                                                                let diskonInput = $row.find('.diskon-item-input-{{ $vn }}');
                                                                let diskon = parseNum{{ $vn }}(diskonInput.val());
                                                                let jenisDiskon = $row.find('.jenis-diskon-item-select-{{ $vn }}').val();

                                                                // Toggle formatting for Diskon input: only format when jenisDiskon === 'Rp'
                                                                if (jenisDiskon === 'Rp') {
                                                                    diskonInput.addClass('currency-input-{{ $vn }}');
                                                                    // Format value if not already formatted
                                                                    formatRupiahInput{{ $vn }}(diskonInput[0]);
                                                                    diskonInput.attr('placeholder', 'Diskon (Rp)');
                                                                } else {
                                                                    // Remove formatting and show plain numeric value if 'Persen'
                                                                    diskonInput.removeClass('currency-input-{{ $vn }}');
                                                                    // Set value to plain number
                                                                    let currentValue = diskonInput.val();
                                                                    diskonInput.val(parseNum{{ $vn }}(currentValue));
                                                                    diskonInput.attr('placeholder', 'Diskon (%)');
                                                                }

                                                                let subTotal = jumlah * hargaSatuan;

                                                                let totalDiskon = 0;
                                                                if (jenisDiskon === 'Rp') {
                                                                    totalDiskon = diskon;
                                                                } else if (jenisDiskon === 'Persen') {
                                                                    totalDiskon = subTotal * (diskon / 100);
                                                                }
                                                                if (totalDiskon > subTotal) totalDiskon = subTotal;

                                                                let totalSetelahDiskon = subTotal - totalDiskon;

                                                                let formattedDiskon = formatRupiah{{ $vn }}(totalDiskon.toFixed(0));
                                                                let formattedTotal = formatRupiah{{ $vn }}(totalSetelahDiskon.toFixed(0));

                                                                $row.find('.total-diskon-input-{{ $vn }}').val(formattedDiskon);
                                                                $row.find('.total-harga-input-{{ $vn }}').val(formattedTotal);

                                                                // Akumulasi total
                                                                let sumSubTotal = 0,
                                                                    sumDiskon = 0,
                                                                    sumTotalHarga = 0;
                                                                $("#table-detail-body-{{ $vn }} tr").each(function() {
                                                                    let tr = $(this);
                                                                    let jml = parseNum{{ $vn }}(tr.find('.jumlah-vendor-input-{{ $vn }}')
                                                                        .val());
                                                                    let satuan = parseNum{{ $vn }}(tr.find('.harga-satuan-input-{{ $vn }}')
                                                                        .val());
                                                                    sumSubTotal += jml * satuan;
                                                                    sumDiskon += parseNum{{ $vn }}(tr.find('.total-diskon-input-{{ $vn }}')
                                                                        .val());
                                                                    sumTotalHarga += parseNum{{ $vn }}(tr.find('.total-harga-input-{{ $vn }}')
                                                                        .val());
                                                                });

                                                                let totalHargaSebelumDiskonAll = sumSubTotal;
                                                                let hargaSetelahDiskonAll = sumTotalHarga;
                                                                let totalDiskonAll = sumDiskon;
                                                                let grandTotalSebelumPPN = sumTotalHarga;
                                                                let ppnGlobal = parseNum{{ $vn }}($('#ppn-persen-{{ $vn }}').val());
                                                                let totalPpnAll = grandTotalSebelumPPN * (ppnGlobal / 100);
                                                                let grandTotal = grandTotalSebelumPPN + totalPpnAll;

                                                                $('#total-harga-sebelum-diskon-all-{{ $vn }}').val(formatRupiah{{ $vn }}(
                                                                    totalHargaSebelumDiskonAll.toFixed(0)));
                                                                $('#total-harga-setelah-diskon-all-{{ $vn }}').val(formatRupiah{{ $vn }}(
                                                                    hargaSetelahDiskonAll.toFixed(0)));
                                                                $('#total-diskon-all-{{ $vn }}').val(formatRupiah{{ $vn }}(totalDiskonAll.toFixed(0)));
                                                                $('#total-ppn-all-{{ $vn }}').val(formatRupiah{{ $vn }}(totalPpnAll.toFixed(0)));
                                                                $('#grand-total-{{ $vn }}').val(formatRupiah{{ $vn }}(grandTotal.toFixed(0)));
                                                            }

                                                            // Init auto hitung & auto format rupiah onload dan perubahan
                                                            $(document).ready(function() {
                                                                $('#table-detail-pembelian-{{ $vn }}').on('input change blur',
                                                                    '.jumlah-vendor-input-{{ $vn }}, .harga-satuan-input-{{ $vn }}, .diskon-item-input-{{ $vn }}, .jenis-diskon-item-select-{{ $vn }}',
                                                                    function() {
                                                                        hitungOtomatis{{ $vn }}(this);
                                                                        // Untuk diskon, handle format hanya saat Rp
                                                                        if ($(this).hasClass('currency-input-{{ $vn }}') &&
                                                                            $(this).is('.diskon-item-input-{{ $vn }}')
                                                                        ) {
                                                                            var $row = $(this).closest('tr');
                                                                            var jenisDiskon = $row.find('.jenis-diskon-item-select-{{ $vn }}').val();
                                                                            if (jenisDiskon === 'Rp') {
                                                                                formatRupiahInput{{ $vn }}(this);
                                                                            }
                                                                        } else if ($(this).hasClass('currency-input-{{ $vn }}')) {
                                                                            formatRupiahInput{{ $vn }}(this);
                                                                        }
                                                                    });

                                                                $('#table-detail-pembelian-{{ $vn }}').on('keyup blur focus',
                                                                    '.currency-input-{{ $vn }}',
                                                                    function() {
                                                                        var $row = $(this).closest('tr');
                                                                        // Untuk diskon, hanya format kalau Rp
                                                                        if ($(this).is('.diskon-item-input-{{ $vn }}')) {
                                                                            var jenisDiskon = $row.find('.jenis-diskon-item-select-{{ $vn }}').val();
                                                                            if (jenisDiskon === 'Rp') {
                                                                                formatRupiahInput{{ $vn }}(this);
                                                                            }
                                                                        } else {
                                                                            formatRupiahInput{{ $vn }}(this);
                                                                        }
                                                                    });

                                                                $('#table-detail-pembelian-{{ $vn }}').on('change',
                                                                    '.jenis-diskon-item-select-{{ $vn }}',
                                                                    function() {
                                                                        // After Jenis Diskon change, update Diskon input behavior
                                                                        var $row = $(this).closest('tr');
                                                                        hitungOtomatis{{ $vn }}($(this));
                                                                    });

                                                                $('#ppn-persen-{{ $vn }}').on('input change', function() {
                                                                    hitungOtomatisGlobal{{ $vn }}();
                                                                });

                                                                // Jalankan kalkulasi pertama kali dan format semua currency
                                                                setTimeout(function() {
                                                                    let $first = $(
                                                                        "#table-detail-body-{{ $vn }} input, #table-detail-body-{{ $vn }} select"
                                                                    ).first();
                                                                    if ($first.length) hitungOtomatis{{ $vn }}($first[0]);
                                                                    $('.currency-input-{{ $vn }}').each(function() {
                                                                        // Untuk diskon, hanya format kalau Rp
                                                                        var $input = $(this);
                                                                        var $row = $input.closest('tr');
                                                                        if ($input.is('.diskon-item-input-{{ $vn }}')) {
                                                                            var jenisDiskon = $row.find(
                                                                                '.jenis-diskon-item-select-{{ $vn }}').val();
                                                                            if (jenisDiskon === 'Rp') {
                                                                                formatRupiahInput{{ $vn }}(this);
                                                                            }
                                                                        } else {
                                                                            formatRupiahInput{{ $vn }}(this);
                                                                        }
                                                                    });

                                                                    // Sync nilai awal Nama Vendor di tabel dengan dropdown utama & lock
                                                                    var mainVendorSelect = $('#vendor_select_{{ $vn }}');
                                                                    var vendorValue = mainVendorSelect.val();
                                                                    $('#table-detail-body-{{ $vn }} select.vendor-name-in-table').each(function() {
                                                                        $(this).val(vendorValue).prop('disabled', true).trigger('change');
                                                                    });
                                                                }, 500);
                                                            });
                                                        </script>
                                                    </div>
                                                </div>
                                            @endfor
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 text-end mt-3">
                            <a href="{{ route('ajukan.index') }}" class="btn btn-secondary me-2">
                                <i class="fa fa-arrow-left"></i> Kembali
                            </a>
                            <button type="submit" class="btn btn-primary me-2" name="submit_type" value="simpan">
                                <i class="fa fa-save"></i> Simpan
                            </button>
                            {{-- <button type="submit" class="btn btn-warning" name="submit_type" value="draft">
                                <i class="fa fa-file-alt"></i> Simpan sebagai Draft
                            </button> --}}
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
@endsection

@push('js')
    <script>
        function calculateVendorDetail(row) {
            let jumlah = parseFloat(row.find('.jumlah-vendor-input').val()) || 0;
            let hargaSatuan = parseFloat(row.find('.harga-satuan-input').val()) || 0;
            let ppnPersen = parseFloat(row.find('.ppn-input').val()) || 0;
            let jenisDiskon = row.find('select[name$="[JenisDiskon]"]').val();
            let nominalDiskon = parseFloat(row.find('.nominal-diskon-input').val()) || 0;

            let subtotal = jumlah * hargaSatuan;

            let diskon = 0;
            if (jenisDiskon === 'persen') {
                diskon = subtotal * (nominalDiskon / 100);
            } else if (jenisDiskon === 'nominal') {
                diskon = nominalDiskon;
            }
            let totalSetelahDiskon = subtotal - diskon;
            let totalPpn = totalSetelahDiskon * (ppnPersen / 100);
            let totalHarga = totalSetelahDiskon + totalPpn;

            row.find('.total-diskon-input').val(Math.round(diskon));
            row.find('.total-ppn-input').val(Math.round(totalPpn));
            row.find('.total-harga-input').val(Math.round(totalHarga));
        }

        $(document).ready(function() {
            // Inisialisasi awal semua baris vendor
            $('#table-detail-vendor tbody tr').each(function() {
                calculateVendorDetail($(this));
            });

            // Trigger kalkulasi setiap ada perubahan di input relevant
            $('#table-detail-vendor').on('input change',
                '.jumlah-vendor-input, .harga-satuan-input, .ppn-input, .nominal-diskon-input, select[name$="[JenisDiskon]"]',
                function() {
                    let row = $(this).closest('tr');
                    calculateVendorDetail(row);
                });
        });
    </script>
    <script>
        // Logic untuk update informasi dan sync drop-down di table
        function updateVendorInfoAndLock(vn) {
            // Update vendor info
            var select = document.getElementById('vendor_select_' + vn);
            var selectedOption = select.options[select.selectedIndex];
            var namaPIC = selectedOption.getAttribute('data-namapic') || '-';
            var noHpPIC = selectedOption.getAttribute('data-nohppic') || '-';

            // Update info di box
            var infoDiv = document.getElementById('vendor_info_' + vn);
            if (infoDiv) {
                infoDiv.querySelector('.vendor_namapic').innerText = namaPIC || '-';
                infoDiv.querySelector('.vendor_nohppic').innerText = noHpPIC || '-';
            }

            // Set semua select vendor pada tabel
            var tableSelector = '#table-detail-body-' + vn + ' select.vendor-name-in-table';
            $(tableSelector).each(function() {
                // Set value, trigger change, disable
                $(this).val(select.value).prop('disabled', true).trigger('change');
            });
        }

        // Inisialisasi: ketika halaman di-load, lock jika sudah ada yg dipilih
        $(document).ready(function() {
            @for ($vnLock = 1; $vnLock <= 3; $vnLock++)
                // Set awal
                updateVendorInfoAndLock({{ $vnLock }});
            @endfor
        });
    </script>
@endpush
